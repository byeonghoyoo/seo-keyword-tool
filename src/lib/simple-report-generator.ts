import jsPDF from 'jspdf';
import * as XLSX from 'xlsx';
import type { KeywordResult } from '@/types';
import { supabaseAdmin } from './supabase';

export interface ReportData {
  jobId: string;
  targetUrl: string;
  domain: string;
  keywords: KeywordResult[];
  analysis: {
    totalKeywords: number;
    avgRanking: number;
    top10Keywords: number;
    adOpportunities: number;
    lowCompetitionKeywords: number;
  };
  generatedAt: Date;
}

export interface ReportOptions {
  format: 'pdf' | 'excel' | 'html';
  sections: {
    summary: boolean;
    keywords: boolean;
    competitors: boolean;
    recommendations: boolean;
  };
  title?: string;
}

class SimpleReportGenerator {
  async generateReport(
    reportData: ReportData,
    options: ReportOptions
  ): Promise<{ downloadUrl: string; fileName: string; fileSize: number }> {
    try {
      let fileName: string;
      let buffer: Buffer;
      let mimeType: string;

      switch (options.format) {
        case 'pdf':
          ({ buffer, fileName } = await this.generatePDFReport(reportData, options));
          mimeType = 'application/pdf';
          break;
        case 'excel':
          ({ buffer, fileName } = await this.generateExcelReport(reportData, options));
          mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
          break;
        case 'html':
          ({ buffer, fileName } = await this.generateHTMLReport(reportData, options));
          mimeType = 'text/html';
          break;
        default:
          throw new Error('Unsupported report format');
      }

      // Store report in database
      await this.storeReport(reportData, options, fileName, buffer.length);

      // Create data URL for download
      const base64Data = buffer.toString('base64');
      const downloadUrl = `data:${mimeType};base64,${base64Data}`;

      return {
        downloadUrl,
        fileName,
        fileSize: buffer.length,
      };

    } catch (error) {
      console.error('Report generation error:', error);
      throw new Error(`Failed to generate report: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
  }

  private async generatePDFReport(
    reportData: ReportData,
    options: ReportOptions
  ): Promise<{ buffer: Buffer; fileName: string }> {
    const doc = new jsPDF();
    let yPosition = 20;

    // Title
    doc.setFontSize(20);
    doc.text(options.title || 'SEO ÌÇ§ÏõåÎìú Î∂ÑÏÑù Î≥¥Í≥†ÏÑú', 20, yPosition);
    yPosition += 20;

    // Basic Info
    doc.setFontSize(12);
    doc.text(`Î∂ÑÏÑù ÎåÄÏÉÅ: ${reportData.targetUrl}`, 20, yPosition);
    yPosition += 10;
    doc.text(`ÎèÑÎ©îÏù∏: ${reportData.domain}`, 20, yPosition);
    yPosition += 10;
    doc.text(`ÏÉùÏÑ±Ïùº: ${reportData.generatedAt.toLocaleDateString('ko-KR')}`, 20, yPosition);
    yPosition += 20;

    // Summary Section
    if (options.sections.summary) {
      doc.setFontSize(16);
      doc.text('üìä Î∂ÑÏÑù ÏöîÏïΩ', 20, yPosition);
      yPosition += 15;

      doc.setFontSize(12);
      doc.text(`Ï¥ù ÌÇ§ÏõåÎìú: ${reportData.analysis.totalKeywords}Í∞ú`, 20, yPosition);
      yPosition += 8;
      doc.text(`ÌèâÍ∑† ÏàúÏúÑ: ${reportData.analysis.avgRanking.toFixed(1)}ÏúÑ`, 20, yPosition);
      yPosition += 8;
      doc.text(`ÏÉÅÏúÑ 10ÏúÑ ÌÇ§ÏõåÎìú: ${reportData.analysis.top10Keywords}Í∞ú`, 20, yPosition);
      yPosition += 8;
      doc.text(`Í¥ëÍ≥† Í∏∞Ìöå: ${reportData.analysis.adOpportunities}Í∞ú`, 20, yPosition);
      yPosition += 8;
      doc.text(`ÎÇÆÏùÄ Í≤ΩÏüÅ ÌÇ§ÏõåÎìú: ${reportData.analysis.lowCompetitionKeywords}Í∞ú`, 20, yPosition);
      yPosition += 20;
    }

    // Keywords Section
    if (options.sections.keywords) {
      doc.setFontSize(16);
      doc.text('üîç Ï£ºÏöî ÌÇ§ÏõåÎìú', 20, yPosition);
      yPosition += 15;

      // Top 20 keywords table
      const topKeywords = reportData.keywords
        .sort((a, b) => a.position - b.position)
        .slice(0, 20);

      doc.setFontSize(10);
      doc.text('ÌÇ§ÏõåÎìú', 20, yPosition);
      doc.text('ÏàúÏúÑ', 80, yPosition);
      doc.text('Í≤ÄÏÉâÎüâ', 120, yPosition);
      doc.text('Í≤ΩÏüÅÎèÑ', 160, yPosition);
      yPosition += 8;

      // Add line
      doc.line(20, yPosition, 190, yPosition);
      yPosition += 8;

      topKeywords.forEach((keyword, index) => {
        if (yPosition > 270) {
          doc.addPage();
          yPosition = 20;
        }

        doc.text(keyword.keyword.slice(0, 25) + (keyword.keyword.length > 25 ? '...' : ''), 20, yPosition);
        doc.text(keyword.position.toString(), 80, yPosition);
        doc.text((keyword.searchVolume || 0).toLocaleString(), 120, yPosition);
        doc.text(keyword.competition || 'N/A', 160, yPosition);
        yPosition += 6;
      });
    }

    // Recommendations Section
    if (options.sections.recommendations) {
      if (yPosition > 200) {
        doc.addPage();
        yPosition = 20;
      }

      doc.setFontSize(16);
      doc.text('üí° Í∞úÏÑ† Í∂åÏû•ÏÇ¨Ìï≠', 20, yPosition);
      yPosition += 15;

      doc.setFontSize(12);
      const recommendations = this.generateRecommendations(reportData);
      
      recommendations.forEach((rec, index) => {
        if (yPosition > 260) {
          doc.addPage();
          yPosition = 20;
        }
        doc.text(`${index + 1}. ${rec}`, 20, yPosition);
        yPosition += 10;
      });
    }

    const fileName = `seo-report-${reportData.domain}-${Date.now()}.pdf`;
    const pdfOutput = doc.output('arraybuffer');
    const buffer = Buffer.from(pdfOutput);

    return { buffer, fileName };
  }

  private async generateExcelReport(
    reportData: ReportData,
    options: ReportOptions
  ): Promise<{ buffer: Buffer; fileName: string }> {
    const workbook = XLSX.utils.book_new();

    // Summary Sheet
    if (options.sections.summary) {
      const summaryData = [
        ['SEO ÌÇ§ÏõåÎìú Î∂ÑÏÑù Î≥¥Í≥†ÏÑú'],
        [''],
        ['Î∂ÑÏÑù ÎåÄÏÉÅ', reportData.targetUrl],
        ['ÎèÑÎ©îÏù∏', reportData.domain],
        ['ÏÉùÏÑ±Ïùº', reportData.generatedAt.toLocaleDateString('ko-KR')],
        [''],
        ['Î∂ÑÏÑù ÏöîÏïΩ'],
        ['Ï¥ù ÌÇ§ÏõåÎìú', reportData.analysis.totalKeywords.toString()],
        ['ÌèâÍ∑† ÏàúÏúÑ', reportData.analysis.avgRanking.toFixed(1)],
        ['ÏÉÅÏúÑ 10ÏúÑ ÌÇ§ÏõåÎìú', reportData.analysis.top10Keywords.toString()],
        ['Í¥ëÍ≥† Í∏∞Ìöå', reportData.analysis.adOpportunities.toString()],
        ['ÎÇÆÏùÄ Í≤ΩÏüÅ ÌÇ§ÏõåÎìú', reportData.analysis.lowCompetitionKeywords.toString()],
      ];

      const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
      XLSX.utils.book_append_sheet(workbook, summarySheet, 'ÏöîÏïΩ');
    }

    // Keywords Sheet
    if (options.sections.keywords) {
      const keywordData = [
        ['ÌÇ§ÏõåÎìú', 'ÏàúÏúÑ', 'ÌéòÏù¥ÏßÄ', 'ÌÉÄÏûÖ', 'Í≤ÄÏÉâÎüâ', 'Í≤ΩÏüÅÎèÑ', 'CPC', 'URL']
      ];

      reportData.keywords.forEach(keyword => {
        keywordData.push([
          keyword.keyword,
          keyword.position.toString(),
          keyword.page.toString(),
          keyword.type,
          (keyword.searchVolume || 0).toString(),
          keyword.competition || '',
          (keyword.estimatedCPC || 0).toString(),
          keyword.url,
        ]);
      });

      const keywordSheet = XLSX.utils.aoa_to_sheet(keywordData);
      XLSX.utils.book_append_sheet(workbook, keywordSheet, 'ÌÇ§ÏõåÎìú Î™©Î°ù');
    }

    // Recommendations Sheet
    if (options.sections.recommendations) {
      const recommendations = this.generateRecommendations(reportData);
      const recData = [
        ['Í∞úÏÑ† Í∂åÏû•ÏÇ¨Ìï≠'],
        [''],
        ...recommendations.map((rec, index) => [`${index + 1}. ${rec}`])
      ];

      const recSheet = XLSX.utils.aoa_to_sheet(recData);
      XLSX.utils.book_append_sheet(workbook, recSheet, 'Í∂åÏû•ÏÇ¨Ìï≠');
    }

    const fileName = `seo-report-${reportData.domain}-${Date.now()}.xlsx`;
    const buffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });

    return { buffer: Buffer.from(buffer), fileName };
  }

  private async generateHTMLReport(
    reportData: ReportData,
    options: ReportOptions
  ): Promise<{ buffer: Buffer; fileName: string }> {
    let html = `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEO ÌÇ§ÏõåÎìú Î∂ÑÏÑù Î≥¥Í≥†ÏÑú</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 40px; line-height: 1.6; }
        .header { border-bottom: 2px solid #3b82f6; padding-bottom: 20px; margin-bottom: 30px; }
        .section { margin-bottom: 40px; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 20px 0; }
        .metric-card { background: #f8fafc; padding: 20px; border-radius: 8px; text-align: center; }
        .metric-value { font-size: 2em; font-weight: bold; color: #3b82f6; }
        .metric-label { color: #64748b; font-size: 0.9em; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f8fafc; font-weight: 600; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîç SEO ÌÇ§ÏõåÎìú Î∂ÑÏÑù Î≥¥Í≥†ÏÑú</h1>
        <p><strong>Î∂ÑÏÑù ÎåÄÏÉÅ:</strong> ${reportData.targetUrl}</p>
        <p><strong>ÎèÑÎ©îÏù∏:</strong> ${reportData.domain}</p>
        <p><strong>ÏÉùÏÑ±Ïùº:</strong> ${reportData.generatedAt.toLocaleDateString('ko-KR')}</p>
    </div>
`;

    if (options.sections.summary) {
      html += `
    <div class="section">
        <h2>üìä Î∂ÑÏÑù ÏöîÏïΩ</h2>
        <div class="summary-grid">
            <div class="metric-card">
                <div class="metric-value">${reportData.analysis.totalKeywords}</div>
                <div class="metric-label">Ï¥ù ÌÇ§ÏõåÎìú</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">${reportData.analysis.avgRanking.toFixed(1)}</div>
                <div class="metric-label">ÌèâÍ∑† ÏàúÏúÑ</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">${reportData.analysis.top10Keywords}</div>
                <div class="metric-label">ÏÉÅÏúÑ 10ÏúÑ ÌÇ§ÏõåÎìú</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">${reportData.analysis.adOpportunities}</div>
                <div class="metric-label">Í¥ëÍ≥† Í∏∞Ìöå</div>
            </div>
            <div class="metric-card">
                <div class="metric-value">${reportData.analysis.lowCompetitionKeywords}</div>
                <div class="metric-label">ÎÇÆÏùÄ Í≤ΩÏüÅ ÌÇ§ÏõåÎìú</div>
            </div>
        </div>
    </div>
`;
    }

    if (options.sections.keywords) {
      const topKeywords = reportData.keywords
        .sort((a, b) => a.position - b.position)
        .slice(0, 50);

      html += `
    <div class="section">
        <h2>üîç ÌÇ§ÏõåÎìú ÏÉÅÏÑ∏ Î∂ÑÏÑù</h2>
        <table>
            <thead>
                <tr>
                    <th>ÌÇ§ÏõåÎìú</th>
                    <th>ÏàúÏúÑ</th>
                    <th>ÌÉÄÏûÖ</th>
                    <th>Í≤ÄÏÉâÎüâ</th>
                    <th>Í≤ΩÏüÅÎèÑ</th>
                    <th>ÏòàÏÉÅ CPC</th>
                </tr>
            </thead>
            <tbody>`;

      topKeywords.forEach(keyword => {
        html += `
                <tr>
                    <td><strong>${keyword.keyword}</strong></td>
                    <td>${keyword.position}ÏúÑ</td>
                    <td>${keyword.type}</td>
                    <td>${(keyword.searchVolume || 0).toLocaleString()}</td>
                    <td>${keyword.competition || 'N/A'}</td>
                    <td>‚Ç©${(keyword.estimatedCPC || 0).toLocaleString()}</td>
                </tr>`;
      });

      html += `
            </tbody>
        </table>
    </div>
`;
    }

    if (options.sections.recommendations) {
      const recommendations = this.generateRecommendations(reportData);
      html += `
    <div class="section">
        <h2>üí° Í∞úÏÑ† Í∂åÏû•ÏÇ¨Ìï≠</h2>
        <ol>`;

      recommendations.forEach(rec => {
        html += `<li>${rec}</li>`;
      });

      html += `
        </ol>
    </div>
`;
    }

    html += `
</body>
</html>
`;

    const fileName = `seo-report-${reportData.domain}-${Date.now()}.html`;
    const buffer = Buffer.from(html, 'utf-8');

    return { buffer, fileName };
  }

  private generateRecommendations(reportData: ReportData): string[] {
    const recommendations: string[] = [];

    if (reportData.analysis.avgRanking > 20) {
      recommendations.push('ÌèâÍ∑† ÏàúÏúÑÍ∞Ä 20ÏúÑ Ïù¥ÌïòÏûÖÎãàÎã§. ÏÉÅÏúÑ Îû≠ÌÇπ ÌÇ§ÏõåÎìúÏóê ÎåÄÌïú ÏΩòÌÖêÏ∏† ÏµúÏ†ÅÌôîÎ•º Ïö∞ÏÑ†Ï†ÅÏúºÎ°ú ÏßÑÌñâÌïòÏÑ∏Ïöî.');
    }

    if (reportData.analysis.top10Keywords < reportData.analysis.totalKeywords * 0.1) {
      recommendations.push('ÏÉÅÏúÑ 10ÏúÑ ÌÇ§ÏõåÎìú ÎπÑÏú®Ïù¥ ÎÇÆÏäµÎãàÎã§. Î°±ÌÖåÏùº ÌÇ§ÏõåÎìúÎ≥¥Îã§Îäî ÌïµÏã¨ ÌÇ§ÏõåÎìú ÏàúÏúÑ Ìñ•ÏÉÅÏóê ÏßëÏ§ëÌïòÏÑ∏Ïöî.');
    }

    if (reportData.analysis.lowCompetitionKeywords > 0) {
      recommendations.push(`${reportData.analysis.lowCompetitionKeywords}Í∞úÏùò ÎÇÆÏùÄ Í≤ΩÏüÅ ÌÇ§ÏõåÎìúÎ•º Î∞úÍ≤¨ÌñàÏäµÎãàÎã§. Ïù¥Îì§ ÌÇ§ÏõåÎìúÏóê ÎåÄÌïú ÏΩòÌÖêÏ∏†Î•º Ïö∞ÏÑ† ÏûëÏÑ±ÌïòÏÑ∏Ïöî.`);
    }

    if (reportData.analysis.adOpportunities > 0) {
      recommendations.push(`${reportData.analysis.adOpportunities}Í∞úÏùò Í¥ëÍ≥† Í∏∞ÌöåÍ∞Ä ÏûàÏäµÎãàÎã§. Ïú†Î£å Í¥ëÍ≥† Ï∫†ÌéòÏù∏ÏùÑ Í≥†Î†§Ìï¥Î≥¥ÏÑ∏Ïöî.`);
    }

    // Add general recommendations
    recommendations.push('Ï†ïÍ∏∞Ï†ÅÏù∏ ÌÇ§ÏõåÎìú ÏàúÏúÑ Î™®ÎãàÌÑ∞ÎßÅÏùÑ ÌÜµÌï¥ ÏàúÏúÑ Î≥ÄÎèôÏùÑ Ï∂îÏ†ÅÌïòÏÑ∏Ïöî.');
    recommendations.push('Í≤ΩÏüÅÏÇ¨Ïùò ÌÇ§ÏõåÎìú Ï†ÑÎûµÏùÑ Î∂ÑÏÑùÌïòÏó¨ ÏÉàÎ°úÏö¥ Í∏∞ÌöåÎ•º Ï∞æÏïÑÎ≥¥ÏÑ∏Ïöî.');
    recommendations.push('Î™®Î∞îÏùº Í≤ÄÏÉâ ÏµúÏ†ÅÌôîÎ•º ÏúÑÌï¥ ÌéòÏù¥ÏßÄ Î°úÎî© ÏÜçÎèÑÎ•º Í∞úÏÑ†ÌïòÏÑ∏Ïöî.');

    return recommendations;
  }

  private async storeReport(
    reportData: ReportData,
    options: ReportOptions,
    fileName: string,
    fileSize: number
  ): Promise<any> {
    try {
      const { data, error } = await supabaseAdmin
        .from('generated_reports')
        .insert({
          job_id: reportData.jobId,
          title: options.title || 'SEO ÌÇ§ÏõåÎìú Î∂ÑÏÑù Î≥¥Í≥†ÏÑú',
          report_type: 'seo_analysis',
          format: options.format,
          status: 'completed',
          file_path: fileName,
          file_size: fileSize,
          sections: options.sections,
          insights: {
            keyFindings: [
              `Ï¥ù ${reportData.analysis.totalKeywords}Í∞ú ÌÇ§ÏõåÎìú Î∂ÑÏÑù`,
              `ÌèâÍ∑† ÏàúÏúÑ ${reportData.analysis.avgRanking.toFixed(1)}ÏúÑ`,
              `ÏÉÅÏúÑ 10ÏúÑ ÌÇ§ÏõåÎìú ${reportData.analysis.top10Keywords}Í∞ú`,
            ],
            recommendations: this.generateRecommendations(reportData).slice(0, 3),
            alerts: reportData.analysis.avgRanking > 50 ? ['ÌèâÍ∑† ÏàúÏúÑÍ∞Ä Îß§Ïö∞ ÎÇÆÏäµÎãàÎã§'] : [],
          },
        })
        .select()
        .single();

      if (error) {
        console.error('Failed to store report:', error);
      }

      return data;
    } catch (error) {
      console.error('Report storage error:', error);
      return null;
    }
  }
}

export const reportGenerator = new SimpleReportGenerator();